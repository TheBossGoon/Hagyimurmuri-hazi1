using System.Data;
using System.Formats.Asn1;
using System.IO;
using System.Text;

namespace ConsoleAppTitkosit
{
    internal class Program
    {
        static int eltolas; //eltolás mértéke
        static void Main(string[] args)
        {

            ConsoleKeyInfo mitValasztott = Menu();
            String sor, fajlNev;
            switch (mitValasztott.Key)
            {
                case ConsoleKey.F1:
                    Console.Write("Kérem a titkosítási kulcsot!:");
                    eltolas = int.Parse(Console.ReadLine());

                    Console.Write("Kérem a titkosítandó szöveget! :");
                   
                    do
                    {
                        
                    sor = Console.ReadLine();
                    FajlbaIr("kodolt.txt", Titkositott(sor, eltolas));
                    }
                    while (sor != "");
                

                    break;
                case ConsoleKey.F2:
                    Console.Write("Kérem a kódolt fájl nevét! :");
                    fajlNev = Console.ReadLine();
                    Console.WriteLine(Visszafejt(FajlbolOlvas(fajlNev)));
                    break;
                default:
                    Console.WriteLine("The end!");
                    return;
            }
        }

        private static string FajlbolOlvas(string fajlNev)
        {
            try
            {
                
            StreamReader sr = new StreamReader(fajlNev);
            eltolas = int.Parse(sr.ReadLine());  //Ezt is vizsgálni kellene!
            String sor = sr.ReadLine();
            int sorokSzama = 2;

            while (!sr.EndOfStream)
            {
                sor += "\n" + sr.ReadLine();
                sorokSzama++;
            }
            string LeghosszabbSor = "";
            int LeghosszabbSorHossza = 0;
            foreach( string asdf in sor.Split("\n")){
                if (asdf.Length >LeghosszabbSorHossza) {
                    LeghosszabbSor = asdf;
                    LeghosszabbSorHossza = LeghosszabbSor.Length;
                }
            }
            System.Console.WriteLine("leghosszabb sor: " + LeghosszabbSor );
            sr.Close();
            return sor;
            }
            catch (FileNotFoundException)
            {
                throw FileNotFoundException("nem taltam a faljlod");
            }
            catch (FormatException)
            {
                throw FormatException("az elso sor nem egy szam");
            }
        }


        /// <summary>
        /// A megadott állományba írja az átalakított szöveget
        /// </summary>
        /// <param name="fileName">Elérési útvonal és a fájl neve</param>
        /// <param name="textLine">A fájlba írandó szöveg</param>
        private static void FajlbaIr(string fileName, string textLine)  //módosítani a paramétert pld string listára
        {
            StreamWriter sw = new StreamWriter(fileName);
            sw.Write(eltolas);
            sw.Write("; ");
            sw.WriteLine(textLine); //Át kell írni
            sw.Close();
        }

        private static ConsoleKeyInfo Menu()
        {
            Console.Clear();
            Console.WriteLine($"[F1] Titkosít");
            Console.WriteLine($"[F2] Visszafejt");
            Console.WriteLine($"[ESC] Vissza");
            ConsoleKeyInfo karakter;
            do
            {
                Console.WriteLine("\nVálasszon !");
                karakter = Console.ReadKey();

            } while (karakter.Key != ConsoleKey.F1 && karakter.Key != ConsoleKey.F2 && karakter.Key != ConsoleKey.Escape);
            return karakter;
        }

        private static string Titkositott(string szoveg, int eltolas)
        {
            StringBuilder kodolt = new StringBuilder();

            foreach (char jel in szoveg)
            {
                int jelUjKodja = (byte)jel + eltolas;
                kodolt.Append((char)jelUjKodja);
            }
            return kodolt.ToString();
        }

        private static string Visszafejt(string szoveg)
        {
            StringBuilder visszafejtett = new StringBuilder();

            foreach (char jel in szoveg)
            {
                int jelUjKodja = (byte)jel - eltolas;
                visszafejtett.Append((char)jelUjKodja);
            }
            return visszafejtett.ToString();
        }
    }
}
